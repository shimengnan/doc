# Hystrix

hystrix 是由Netflix 开源的一个延迟和容错库,用于隔离访问远程系统,服务,或者第三方库,防止级联失败,提升系统的可用性与容错性.

## 雪崩效应

在微服务架构中,服务调用链条通常会包含多层服务.微服务中间通过网络进行通信,从而支撑整体系统的应用.因此.在服务中 难免存在依赖关系.

任何微服务都不一定是100%可用,网络往往也很脆弱,因此服务间的调用很可能会失败.

我们常把 由 `基础服务故障` 导致 `级联故障`的现象称之为 `雪崩效应`. 雪崩效应描述的是 因为服务提供者的不可用,导致消费者不可用,并逐渐放大失败的过程.



在常见调用场景中,如果服务 提供者响应非常缓慢.那么消费者对提供者的请求就会被强制等待.直到提供者响应内容 或 超时.在高负载场景下.若不做任何处理,此类问题很可能会导致服务消费者的资源耗尽,甚至引发消费者整体系统的崩溃.

当依赖的服务出现问题时,服务自身不应被拖垮.这是我们需要用 Hystrix 解决的问题.

## 容错的手段

为了防止出现雪崩效应,必须有一个强大的容错机制.至少包含以下两点:

### 设置请求超时时间

正常情况下,一个远程调用一般在几十毫秒内就能得到响应.如果依赖的服务不可用或者网络有问题,那么响应时间就变得很长(几十秒). 一个远程调用一般对应一个线程资源.如果响应太慢,这个线程的资源得不到释放.那么随着调用重复.可能会耗尽系统资源.导致服务不可用.

因此必须为每个请求设置超时,超时立即释放资源.

### 使用断路器

类似于保险丝,当电流过大时,断路器打开跳闸,保护电路安全.当电流过大问题(超载)解决后,断路器关闭,恢复正常电路.

同样对于请求来说,如果对某个服务的请求有大量超时(该服务请求可能不可用),继续访问该服务已经没有意义,只会无畏消耗资源.例如,设置了超时时间为1秒,如果短时间内 有大量的请求无法在1秒内得到相应,就不在请求依赖的服务.

断路器可以理解为,对容易导致错误的操作的代理.这种代理能够统一一段时间内调用失败的次数,并决定继续请求,还是直接返回.

断路器快速失败:在一段时间内检测到许多错误(超时),会在之后的一段时间内,强迫对该服务的调用快速失败.

断路器自动诊断:快速失败后,若依赖的服务是否已经恢复正常,那么就会恢复该服务的调用,自我修复.

当下游服务不正常时打开断路器快速失败,防止雪崩,正常时 恢复请求.

断路器状态:

关闭:请求正常调用,统计失败次数

打开:请求失败率达到一定阈值,不在请求直接返回

半开:打开一段时间后,自动进入半开状态,允许一个请求访问依赖的服务,若调用成功关闭断路器.否则继续保持打开