# C10K问题

## 1 问题由来

随着互联网的普及,应用用户群体几何增长,服务器性能问题出现.最初的服务器是基于进程/线程模型. 新到来一个TCP 连接,就需要分配一个进程. 若有C10K ,就需要1w个 进程/线程.这是无法承受的.

## 2 问题本质

C10K 问题的本质是操作系统的问题.对于web1.0/2.0 时代的操作系统.传统的同步阻塞IO模型处理方式都是request per second.当创建的进程或线程多了,数据拷贝频繁(缓存IO,内核 拷贝数据到用户进程空间) 阻塞,进程上下文切换消耗大,导致操作系统崩溃.这是C10K 问题的本质.

## 3 C10K 问题的解决方案

每个进程/线程 同时处理多个连接(IO多路复用)

### 3.1 select /poll方式

顺序扫描多个fd，监听socket 的数量有限制（默认是1024）。

select/poll 有一个致命弱点，当socket集合过大时，同一时刻 只有少部分的 socket 是活跃的。但 select/poll 每次还是会循环所有socket 列表，导致效率线性下降。

### 3.2 epoll 方式

同时监听多个fd，监听socket 数量基本没有限制（受限于操作系统的最大文件句柄数）

操作系统最大文件句柄数 可以通过cat /proc/sys/fs/file-max 查看。这个数字一般与操作系统内存有关，一般1G 内存对应10w个句柄左右。

epoll 同时事件监听，只会多活跃的socket 进行操作。只有活跃的socket 才会调用call bock 函数。

无论 epoll 还是select/poll 都需要将数据从kernel 复制到 用户进程。如何避免不必要的内存复制就很重要。 epoll 通过 内核 和用户空间mmap 同一块内存来避免此问题。

```
mmap操作提供了一种机制，让用户程序直接访问设备内存，这种机制，相比较在用户空间和内核空间互相拷贝数据，效率更高。在要求高性能的应用中比较常用。mmap映射内存必须是页面大小的整数倍，面向流的设备不能进行mmap，mmap的实现和硬件有关。
```

## 3.3 异步IO 

见UNIX IO 模型



## 参考

https://www.jianshu.com/p/ba7fa25d3590

https://blog.csdn.net/imxiangzi/article/details/81014048

https://www.jianshu.com/p/096e1b58c678

