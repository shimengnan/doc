# 网关

## 网关涵盖的基本功能

- 统一接入:多APP 端接入,Android,IOS,PC等
- 协议适配: http 协议转化成下游RPC 协议,如http 转dubbo等
- 流量管控与容错:限流,降级,熔断
- 安全防护:IP白名单等

## 网关基石--泛化调用

### 简介

不直接依赖下游RPC接口JAR,来实现远程调用.使用 Map 代替POJO,通过GenericService 来调用同类协议的所有接口.

### 发布API 到网关

利用什么方法将RPC 环境下的API 让网关系统也能够识别该接口.

利用redis 或 Eureka 等 录入RPC 环境下的API 接口信息,然后通过 泛化调用的基础支持.

## 管道技术

责任链模式

参数校验->黑白名单->限流控制...... ->接口调用

## 网关 IO 模式

- 同步网关		
- 半同步网关    
- 全异步网关    

把 同步网关 与 半同步网关 成为传统网关 .

做网关需要一种异步思维,网关接收外部调用者的request 请求,可以利用异步的思想将IO请求与 业务工作线程分开.

对于一个网关来说,属于IO 密集型的场景,是一种纯 输入/输出的操作.在同步条件下常常会因为后台服务变慢而导致IO阻塞,线程在大部分情况下都处于等待阻塞的状态(导致频繁的线程切换).半同步状态,即使IO请求不受限制,但还是会同步调用后端RPC 请求.

### 同步网关

从接收请求到调用API 接口提供方的过程都是同步调用

### 半同步

将IO 线程 与业务处理线程分开,但业务线程内部还是同步调用API 接口

可以利用 Servlet 3 异步特性实现

### 全异步

整个链路均是异步请求.

利用Servlet 3 异步特性实现IO 线程异步

利用队列或map 实现RPC 调用异步.

### 重要硬件

CPU

​	大访问量下,线程数主键升高,直至将CPU资源耗尽.蔓延整个网关集群.造成雪崩

磁盘

​	通过`iostat` 来关注磁盘IO负载

网络

​	在RPC 环境下,网络占据了一次RPC 调用所消耗时间的很大比重.

### Servlet3 的Async

一个Http 请求的处理分为两部分,一是HTTP 协议自身的解析,比如`READ BODY`的读取,二是业务逻辑的处理.在Servlet3之前,这两部分都是tomcat 中一个线程去处理.3.0版本以后,支持 请求线程(IO)和业务处理线程分开,进而对业务线程进行隔离.

### Servlet3 调用过程

收到request 请求,由tomcat 工作线程从HttpServletRequest 中获取一个异步上下文AsyncContext对象,然后由tomcat 工作线程把(IO线程)把AsyncContext对象传递给业务工作线程处理,同时Tomcat 工作线程归还到线程池中.在业务处理线程中完成业务逻辑的处理,生成response 给客户端.

## 脱库 与 多级缓存

网关系统搭建的时候,脱库操作,直接使用缓存.

缓存的失效方式:

1.设置过期时间--关注穿透率

2.缓存持久化--对db 的容错方法,当db 挂掉时,还可以请求redis 数据

3.订阅数据库binlog-- 使用队列,异步将binlog 同步至redis 缓存,同时还可以设置多级缓存

## 热更新

不需要重启服务,就能够让程序的属性值发生变化,属于热更新.

常见的热更新方式有MQ 方式,RPC 方式 和 Zookeeper 方式.

### MQ

​	将需要更新的数据发送到mq,服务端消费数据,更新属性

### RPC

​	直连RPC 服务器更新数据

### Zookeeper

​	接收更新从而触发本地对象

## 网关的7中武器

异步

降级

限流

熔断

线程池隔离

管道技术

热更新

